name: Build Windows (Tauri)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            boltpage/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: boltpage/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('boltpage/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install NSIS (with retries and fallbacks)
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          function Has-Makensis {
            return [bool](Get-Command makensis -ErrorAction SilentlyContinue)
          }
          if (Has-Makensis) {
            Write-Host "NSIS already installed."
            exit 0
          }

          Write-Host "Attempting Chocolatey install of NSIS..."
          for ($i=1; $i -le 3; $i++) {
            choco install nsis -y --no-progress
            if ($LASTEXITCODE -eq 0 -and (Has-Makensis)) { break }
            Start-Sleep -Seconds (10 * $i)
          }

          if (-not (Has-Makensis)) {
            Write-Host "Chocolatey failed; attempting winget install of NSIS..."
            winget install -e --id NSIS.NSIS -h --accept-source-agreements --accept-package-agreements
          }

          if (-not (Has-Makensis)) {
            Write-Host "winget failed; downloading NSIS installer from SourceForge..."
            $url = 'https://downloads.sourceforge.net/project/nsis/NSIS%203/3.10/nsis-3.10-setup.exe'
            $tmp = "$env:TEMP\nsis-setup.exe"
            Invoke-WebRequest $url -OutFile $tmp
            Start-Process $tmp -ArgumentList '/S' -Wait
          }

          if (-not (Has-Makensis)) {
            Write-Error "Failed to install NSIS (makensis not found)"
            exit 1
          }

      - name: Install dependencies
        working-directory: boltpage
        run: npm ci

      - name: Build Windows NSIS installer
        working-directory: boltpage
        env:
          # Optional Windows code signing; set these as repository secrets if available
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --bundles nsis

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boltpage-windows
          path: |
            boltpage/target/release/bundle/nsis/*.exe
            boltpage/target/release/boltpage.exe

  # Optional MSI job using WiX (uncomment to enable)
  # build-msi:
  #   runs-on: windows-latest
  #   defaults:
  #     run:
  #       shell: powershell
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #     - uses: dtolnay/rust-toolchain@stable
  #     - name: Install WiX
  #       run: choco install wixtoolset --version 3.14.0.2921 -y
  #     - name: Install dependencies
  #       working-directory: boltpage
  #       run: npm ci
  #     - name: Build MSI
  #       working-directory: boltpage
  #       run: npm run tauri build -- --bundles msi
  #     - name: Upload MSI artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: boltpage-msi
  #         path: boltpage/target/release/bundle/msi/*.msi
