name: Build Windows (Tauri)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            boltpage/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: boltpage/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('boltpage/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Ensure NSIS is available (simple)
        run: |
          $ErrorActionPreference = 'Continue'
          Write-Host "Installing NSIS via Chocolatey (idempotent)..."
          choco install nsis -y --no-progress
          if ($LASTEXITCODE -ne 0) { Write-Host "choco returned $LASTEXITCODE; continuing regardless" }
          # Unconditionally add typical NSIS install paths to PATH for current + subsequent steps
          $pf86 = [Environment]::GetFolderPath('ProgramFilesX86')
          $pf64 = [Environment]::GetFolderPath('ProgramFiles')
          $paths = @((Join-Path $pf86 'NSIS'), (Join-Path $pf64 'NSIS'))
          foreach ($p in $paths) {
            if (Test-Path $p) {
              $env:Path = "$env:Path;$p"
              "$p" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
          }
          Write-Host "NSIS path hints added; proceeding to build. If NSIS is actually missing, the build will fail clearly."

      - name: Install dependencies
        working-directory: boltpage
        run: npm ci

      - name: Build Windows NSIS installer
        working-directory: boltpage
        env:
          # Optional Windows code signing; set these as repository secrets if available
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --bundles nsis

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boltpage-windows
          path: |
            boltpage/target/release/bundle/nsis/*.exe
            boltpage/target/release/boltpage.exe

  # Optional MSI job using WiX (uncomment to enable)
  # build-msi:
  #   runs-on: windows-latest
  #   defaults:
  #     run:
  #       shell: powershell
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #     - uses: dtolnay/rust-toolchain@stable
  #     - name: Install WiX
  #       run: choco install wixtoolset --version 3.14.0.2921 -y
  #     - name: Install dependencies
  #       working-directory: boltpage
  #       run: npm ci
  #     - name: Build MSI
  #       working-directory: boltpage
  #       run: npm run tauri build -- --bundles msi
  #     - name: Upload MSI artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: boltpage-msi
  #         path: boltpage/target/release/bundle/msi/*.msi
